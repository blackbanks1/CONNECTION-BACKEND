<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Connection – Track Delivery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background: #f3f4f6;
      color: #333;
    }

    /* Header */
    .header {
      padding: 12px 18px;
      background: white;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #ddd;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .logo {
      height: 36px;
      margin-right: 12px;
    }

    .title {
      font-size: 20px;
      font-weight: 600;
    }

    /* Map card */
    .map-card {
      margin: 14px auto;
      width: 92%;
      max-width: 900px;
      height: 70vh;
      background: white;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      display: none;
      opacity: 0;
      transition: opacity 0.6s ease;
      position: relative; /* ensure overlay elements position correctly */
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .fade-in {
      opacity: 1 !important;
    }

    /* Permission box */
    .permission-box {
      margin: 40px auto;
      padding: 22px;
      background: white;
      width: 90%;
      max-width: 380px;
      text-align: center;
      border-radius: 14px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      animation: fadeInUp 0.6s ease;
    }

    .permission-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .btn {
      margin-top: 16px;
      padding: 12px 20px;
      width: 100%;
      background: #2563eb;
      border-radius: 8px;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: background 0.2s ease;
    }

    .btn:hover {
      background: #1e4ed8;
    }

    /* Stats box */
    .stats-box {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      min-width: 220px;
      min-height: 36px;
      background: rgba(255,255,255,0.98);
      border-radius: 12px;
      padding: 10px 16px;
      box-shadow: 0 10px 30px rgba(12,36,80,0.12);
      font-weight: 700;
      display: none;
      z-index: 9999;
      text-align: center;
      font-size: 15px;
    }

    /* Responsive tweaks */
    @media (max-width: 450px) {
      .stats-box {
        bottom: 8px;
        min-width: 180px;
        padding: 8px 12px;
        font-size: 13px;
      }
    }

    @media (max-width: 350px) {
      .stats-box {
        bottom: 6px;
        min-width: 160px;
        padding: 6px 10px;
        font-size: 12px;
      }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>

  <!-- Load libraries FIRST -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>

<body>
  <!-- HEADER -->
  <div class="header">
    <img src="/static/logo.png" class="logo" onerror="this.src='/static/placeholder.png'">
    <div class="title">Connection – Live Tracking</div>
  </div>

  <!-- Location Permission Box -->
  <div id="permBox" class="permission-box">
    <div class="permission-title">Location Required</div>
    <p>We need your location to calculate real-time distance and ETA.</p>
    <button class="btn" onclick="requestLocation()">Allow Location</button>
  </div>

  <!-- Map container -->
  <div id="mapCard" class="map-card">
    <div id="map"></div>
    <div id="stats" class="stats-box"></div>
    <!-- Delivery Over button (hidden until active session) -->
    <button id="endBtn" class="btn" style="position:absolute; top:12px; right:12px; width:auto; padding:8px 14px; font-size:13px; display:none;">
      Mark Delivery Over
    </button>
  </div>

<!-- ============================================================
     RECEIVER JAVASCRIPT — MOVED TO THE BOTTOM (FIX)
============================================================ -->
<script>
/* ===========================
   RECEIVER DASHBOARD SCRIPT
   =========================== */

/* --- State --- */
let deliveryId = "{{ delivery_id }}";  // Replace with backend variable
console.log("[Receiver] deliveryId =", deliveryId);

let map = null;
let driverMarker = null;
let receiverMarker = null;
let routePolyline = null;

let lastRouteCall = 0;
const ROUTE_THROTTLE_MS = 1300;

let socket;

/* ===========================
   SOCKET INIT
=========================== */
function initSocket() {
  socket = io(window.location.origin, {
    transports: ["websocket", "polling"]
  });

  socket.on("connect", () => {
    console.log("[Receiver] Socket connected:", socket.id);
    joinRoom();
    // Show the "Mark Delivery Over" button once connected to a delivery
    const endBtn = document.getElementById("endBtn");
    if (endBtn && deliveryId) {
      endBtn.style.display = "block";
    }
  });

  socket.on("connect_error", e => console.error("[Receiver] Socket error:", e));
  socket.on("disconnect", () => console.log("[Receiver] Socket disconnected"));
}

initSocket();

/* ===========================
   DRIVER UPDATES
=========================== */
socket.on("driver_update", (data) => {
  if (!data || data.lat === undefined || data.lng === undefined) return;

  const lat = parseFloat(data.lat);
  const lng = parseFloat(data.lng);

  if (!driverMarker && map) {
    // Custom driver icon
    const driverIcon = L.icon({
      iconUrl: "/static/driver.png",
      iconSize: [24, 24],
      iconAnchor: [12, 12],
      popupAnchor: [0, -10]
    });

    driverMarker = L.marker([lat, lng], { title: "Driver", icon: driverIcon }).addTo(map);
  } else if (driverMarker) {
    moveMarkerSmooth(driverMarker, { lat, lng }, 800);
  }

  // Update route and bounds if receiver marker exists
  if (receiverMarker) {
    const rPos = receiverMarker.getLatLng();
    requestRoute({ lat, lng }, { lat: rPos.lat, lng: rPos.lng });
    fitMapToMarkers();
  }
});

/* ===========================
   RECEIVER UPDATES
=========================== */
socket.on("receiver_update", (data) => {
  if (!data || data.lat === undefined || data.lng === undefined) return;

  const lat = parseFloat(data.lat);
  const lng = parseFloat(data.lng);

  if (!receiverMarker && map) {
    receiverMarker = L.marker([lat, lng], { title: "You" }).addTo(map);
  } else {
    moveMarkerSmooth(receiverMarker, { lat, lng }, 800);
  }

  if (driverMarker) {
    const dPos = driverMarker.getLatLng();
    requestRoute({ lat: dPos.lat, lng: dPos.lng }, { lat, lng });
    fitMapToMarkers();
  } else if (map) {
    map.flyTo([lat, lng], 14);
  }
});

/* ===========================
   JOIN ROOM
=========================== */
function joinRoom() {
    if (!deliveryId) return;

    console.log("[Receiver] Joining room:", deliveryId);
    socket.emit("join_delivery", { delivery_id: deliveryId, role: "receiver" });

    socket.on("join_delivery", (data) => {
  console.log("[Receiver] Successfully joined:", data);
  // ✅ Show the button only now
  const endBtn = document.getElementById("endBtn");
  if (endBtn) endBtn.style.display = "block";
});
    
}

/* ===========================
   MAP INIT
=========================== */
function requestLocation() {
    if (!navigator.geolocation) {
        alert("Your device does not support GPS.");
        return;
    }

    navigator.geolocation.getCurrentPosition(
        pos => {
            document.getElementById("permBox").style.display = "none";
            const card = document.getElementById("mapCard");
            card.style.display = "block";
            card.classList.add("fade-in");

            initMap(pos.coords.latitude, pos.coords.longitude);
            startReceiverTracking();
        },
        () => alert("Location is required for live updates."),
        { enableHighAccuracy: true }
    );
}

function initMap(lat, lng) {
    map = L.map("map").setView([lat, lng], 15);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
    }).addTo(map);

    // Always create receiver marker immediately
    receiverMarker = L.marker([lat, lng], { title: "You" }).addTo(map);

    // If driverMarker already exists (from socket), include in bounds
    fitMapToMarkers();

    console.log("[Receiver] Map initialized");
}

/* ===========================
   SMOOTH MARKER ANIMATION
=========================== */
function moveMarkerSmooth(marker, newLatLng, duration = 500) {
    if (!marker) return;
    const start = marker.getLatLng();
    const end = L.latLng(newLatLng.lat, newLatLng.lng);
    const startTime = performance.now();

    function animate(time) {
        const progress = Math.min((time - startTime) / duration, 1);
        const lat = start.lat + (end.lat - start.lat) * progress;
        const lng = start.lng + (end.lng - start.lng) * progress;
        marker.setLatLng([lat, lng]);
        if (progress < 1) requestAnimationFrame(animate);
    }

    requestAnimationFrame(animate);
}

/* ===========================
   FIT MAP TO MARKERS
=========================== */
function fitMapToMarkers() {
    if (!map) return;
    const bounds = L.latLngBounds([]);
    if (driverMarker) bounds.extend(driverMarker.getLatLng());
    if (receiverMarker) bounds.extend(receiverMarker.getLatLng());
    if (routePolyline) bounds.extend(routePolyline.getBounds());
    if (bounds.isValid()) map.flyToBounds(bounds, { padding: [80, 80], maxZoom: 17 });
}

/* ===========================
   ROUTE REQUEST
=========================== */

async function requestRoute(start, end) {
    if (!start || !end) return;

    const now = Date.now();
    if (now - lastRouteCall < ROUTE_THROTTLE_MS) return;
    lastRouteCall = now;

    try {
        const res = await fetch("/api/route", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ start, end })
        });

        const j = await res.json();

        if (!res.ok || !j) {
            console.warn("Route API error", j);
            return;
        }

        // -------------------------
        // DRAW POLYLINE
        // -------------------------
        if (routePolyline) {
            map.removeLayer(routePolyline);
            routePolyline = null;
        }

        if (j.polyline && Array.isArray(j.polyline) && j.polyline.length > 1) {
            routePolyline = L.polyline(j.polyline, {
                color: "#0077ff",
                weight: 5,
                opacity: 0.95
            }).addTo(map);
        } else {
            // fallback straight line
            routePolyline = L.polyline(
                [
                    [start.lat, start.lng],
                    [end.lat, end.lng]
                ],
                { color: "#0077ff", weight: 5, opacity: 0.95 }
            ).addTo(map);
        }

        // -------------------------
        // SHOW DISTANCE + ETA
        // -------------------------
        const stats = document.getElementById("stats");
        if (stats) {
            const distanceKm = j.distance_km ?? 0;
            const etaMin = j.eta_min ?? 0;

            stats.style.display = "block";
            stats.innerText = `${formatKm(distanceKm)} · ${formatMin(etaMin)}`;
        }

        // -------------------------
        // FIT MAP TO MARKERS & ROUTE
        // -------------------------
        fitMapToActors();

    } catch (err) {
        console.error("requestRoute error:", err);
    }
}


/* ===========================
   RECEIVER GPS TRACKING
=========================== */
function startReceiverTracking() {
    navigator.geolocation.watchPosition(
        pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            if (receiverMarker) moveMarkerSmooth(receiverMarker, { lat, lng }, 800);

            socket.emit("receiver_update", { delivery_id: deliveryId, lat, lng });

            if (driverMarker) {
                const dPos = driverMarker.getLatLng();
                requestRoute({ lat: dPos.lat, lng: dPos.lng }, { lat, lng });
                fitMapToMarkers();
            }
        },
        err => console.warn("GPS error:", err),
        { enableHighAccuracy: true }
    );
}

/* ===========================
   DEBUG HELPER
=========================== */
function simulateDriver(lat, lng) {
    if (!deliveryId) return;
    socket.emit("driver_update", { delivery_id: deliveryId, lat, lng });
}

</script>

</body>
</html>
