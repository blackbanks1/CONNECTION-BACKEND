<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Connection – Track Delivery</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

    <style>
        body {
            margin: 0;
            font-family: "Inter", sans-serif;
            background: #f3f4f6;
        }

        /* HEADER (matches driver.html) */
        .header {
            padding: 12px;
            background: white;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }

        .logo {
            height: 36px;
            margin-right: 12px;
        }

        .title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

       /* MAP CARD CONTAINER */
.map-card {
    margin: 14px auto;
    width: 92%;
    max-width: 900px;
    height: 70vh;            /* NOT full screen */
    background: white;
    border-radius: 18px;
    overflow: hidden;        /* round corners affect map */
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    display: none;
    opacity: 0;
    transition: opacity 0.6s ease;
}

/* The Leaflet map inside */
#map {
    width: 100%;
    height: 100%;
}
.fade-in {
    opacity: 1 !important;
}


        /* Small permission card */
        .permission-box {
            margin: 40px auto;
            padding: 22px;
            background: white;
            width: 90%;
            max-width: 380px;
            text-align: center;
            border-radius: 14px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .permission-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
        }

        .btn {
            margin-top: 16px;
            padding: 12px 20px;
            width: 100%;
            background: #2563eb;
            border-radius: 8px;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
        }

        /* Bottom floating stats */
        .stats-box {
            position: fixed;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 16px;
            border-radius: 14px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            font-weight: 600;
            color: #333;
            display: none;
            z-index: 9999;
        }
    </style>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>

<body>

<!-- HEADER -->
<div class="header">
    <img src="/static/logo.png" class="logo">
    <div class="title">Connection – Live Tracking</div>
</div>

<!-- Location Permission -->
<div id="permBox" class="permission-box">
    <div class="permission-title">Location Required</div>
    <p>We need your location to calculate real-time distance and ETA.</p>
    <button class="btn" onclick="requestLocation()">Allow Location</button>
</div>

<!-- MAP -->
<div id="mapCard" class="map-card">
    <div id="map"></div>
</div>


<!-- ETA + Distance -->
<div id="stats" class="stats-box"></div>

<script>
/* ============================================================
   STATE
============================================================ */

let deliveryId = "{{ delivery_id }}";
console.log("RECEIVER deliveryId =", "{{ delivery_id }}");

let map, driverMarker, receiverMarker, routePolyline;

let socket = io();

let lastRouteCall = 0;
const ROUTE_THROTTLE = 1300;

/* ============================================================
   PERMISSION + MAP INIT
============================================================ */

function requestLocation() {
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            document.getElementById("permBox").style.display = "none";


        const card = document.getElementById("mapCard");
        card.style.display = "block";
        card.classList.add("fade-in");


            initMap(pos.coords.latitude, pos.coords.longitude);
            joinRoom();
            startReceiverTracking();
        },
        () => alert("Location is required for live updates."),
        { enableHighAccuracy: true }
    );
}

function initMap(lat, lng) {
    map = L.map("map").setView([lat, lng], 15);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
    }).addTo(map);

    receiverMarker = L.marker([lat, lng], { title: "You" }).addTo(map);
}

/* ============================================================
   SOCKET – DRIVER UPDATES
============================================================ */

function joinRoom() {
    socket.emit("join_delivery", {
    delivery_id: deliveryId,
    role: "receiver"
});


    socket.on("driver_update", data => {
        if (!data.lat || !data.lng) return;

        if (!driverMarker) {
            driverMarker = L.marker([data.lat, data.lng], { title: "Driver" }).addTo(map);
        } else {
            driverMarker.setLatLng([data.lat, data.lng]);
        }

        updateRoute();
    });
}

/* ============================================================
   RECEIVER REALTIME GPS
============================================================ */

function startReceiverTracking() {
    navigator.geolocation.watchPosition(
        (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            receiverMarker.setLatLng([lat, lng]);

            socket.emit("receiver_update", {
                delivery_id: deliveryId,
                lat: lat,
                lng: lng
            });

            updateRoute();
        },
        () => {},
        { enableHighAccuracy: true }
    );
}

/* ============================================================
   ROUTE CALCULATION
============================================================ */

async function updateRoute() {
    if (!driverMarker || !receiverMarker) return;

    const now = Date.now();
    if (now - lastRouteCall < ROUTE_THROTTLE) return;
    lastRouteCall = now;

    const start = driverMarker.getLatLng();
    const end = receiverMarker.getLatLng();

    try {
        const res = await fetch("/api/route", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                start: { lat: start.lat, lng: start.lng },
                end: { lat: end.lat, lng: end.lng }
            })
        });

        const data = await res.json();
        if (!res.ok) return;

        drawRoute(data.polyline);
        showStats(data.distance_km, data.eta_min);

    } catch (err) {
        console.log("ROUTE ERROR:", err);
    }
}

function drawRoute(poly) {
    if (!map) return;

    // if map is hidden
    const card = document.getElementById("mapCard");
    if (card.style.display === "none") return;

    // remove old route
    if (routePolyline) {
        map.removeLayer(routePolyline);
        routePolyline = null;
    }

    // nothing to draw
    if (!poly || poly.length === 0) return;

    routePolyline = L.polyline(poly, {
        color: "#0077ff",
        weight: 5,
        opacity: 0.95
    }).addTo(map);

    // include markers in bounds
    let bounds = routePolyline.getBounds();
    if (driverMarker) bounds.extend(driverMarker.getLatLng());
    if (receiverMarker) bounds.extend(receiverMarker.getLatLng());

    map.fitBounds(bounds, { padding: [80, 80], maxZoom: 17 });
}


function showStats(km, min) {
    const box = document.getElementById("stats");
    box.style.display = "block";
    box.textContent = `${km.toFixed(2)} km • ${Math.round(min)} min`;
}


function normalizeRwandaNumber(num) {
    if (!num) return null;
    num = num.replace(/\D/g, "");

    if (num.startsWith("07")) {
        return "250" + num.slice(1);
    }
    if (num.startsWith("2507")) {
        return num;
    }
    if (num.length === 9 && num.startsWith("7")) {
        return "250" + num;
    }
    return num;
}

function openWhatsApp(phoneNumber, message) {
    const normalized = normalizeRwandaNumber(phoneNumber);

    if (!normalized) {
        alert("WhatsApp number missing");
        return;
    }

    const encoded = encodeURIComponent(message || "");
    const url = `https://wa.me/${normalized}?text=${encoded}`;
    window.location.href = url;
}


</script>

</body>
</html>
