<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Connection â€” Driver Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
:root{
    --accent: #0066ff;
    --muted: #667085;
    --success: #00b894;
    --whatsapp: #25D366;
}

body {
    margin: 0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: #f4f6f9;
    -webkit-font-smoothing: antialiased;
    color: #222;
}

.navbar {
    display:flex; align-items:center; gap:.75rem;
    background: var(--accent); color: #fff; padding:12px 18px;
    font-weight:700;
}
.navbar img{ height:34px; }

.container {
    max-width:1100px; margin:16px auto; padding:0 14px;
}

.card {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 12px 36px rgba(12,36,80,0.06);
    padding: 16px;
}

.row { 
    display:flex; 
    gap:18px; 
    align-items:flex-start; 
}

.col-left { 
    width:360px; 
    max-width:36%; 
}

.col-right {
    flex: 1;
    min-height: 360px;
    height: 60vh;
}


h3 { margin:0 0 8px 0; font-size:18px; }
label { display:block; margin-bottom:6px; color:var(--muted); font-size:13px; }
.input {
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6e9ef; font-size:15px;
    box-sizing:border-box;
}

.button {
    width:100%; padding:12px; border-radius:10px; border:none; font-weight:700; cursor:pointer;
    background:var(--accent); color:#fff; margin-top:12px; font-size:15px;
}
.button.whatsapp { background: var(--whatsapp); margin-top:8px; }

.link-box {
    display:block; margin-top:12px; padding:10px 12px; border-radius:8px; background:#eef6ff;
    color:var(--accent); word-break:break-all; text-decoration:none;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.03);
}

/* MAP BOX */
.map-box {
    margin-top:0;
    background: #ffffff;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 16px 48px rgba(12,36,80,0.06);
    position: relative;
    overflow:visible ;
    min-height: 360px;
}

#map {
    width: 100%;
    height: 100%;
    min-height: 300px;
    opacity: 0;
    position: relative;
    pointer-events: none;
    z-index: 1;
    transition: opacity 0.45s ease;
}

/* Fade-in */
.fade-in { animation: fadeIn 0.5s ease forwards; }
@keyframes fadeIn { from { opacity:0; transform: translateY(10px);} to { opacity:1; transform:none;} }

/* Bottom stats */
.bottom-stats {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: 18px;
    min-width: 120px;
    background: rgba(156, 113, 113, 0.98);
    border-radius: 12px;
    padding: 8px 12px;
    box-shadow: 0 10px 30px rgba(12,36,80,0.12);
    font-weight:700;
    display:none;
    z-index: 2000;
    text-align:center;
}

.notice { color:var(--muted); font-size:13px; margin-top:8px; }

/* ================================
   RESPONSIVENESS IMPROVEMENTS
   ================================ */

/* Tablet + mobile */
@media (max-width: 900px) {
    .row { 
        flex-direction:column; 
    }
    .col-left { 
        width:100%; 
        max-width:100%; 
    }
    .map-box { 
        padding: 6px; 
    }
    #map { 
        height: 60vh; 
    }
}

/* Small phones */
@media (max-width: 450px) {
    .bottom-stats {
        min-width:120px;
        bottom: 6px;          
        padding: 8px 10px;    
        font-size: 14px;      
    }
}

/* Ultra-small devices */
@media (max-width: 350px) {
    #map {
        min-height: 300px;    
    }
}

    </style>
</head>
<body>
    <div class="navbar">
        <img src="/static/logo.png" alt="logo">
        Connection â€” Driver
    </div>

    <div class="container">
        <div class="card row">
            <div class="col-left">
                <h3>Start a Delivery Session</h3>

                <label for="receiver_phone">Receiver Phone Number</label>
                <input id="receiver_phone" class="input" placeholder="E.g. 0788 123 456" />

                <button class="button" id="create_btn" onclick="createSession()">Create Session</button>

                <p class="notice">Please allow location access when your browser asks.</p>

                <div id="tracking_box" style="display:none;">
                    <a id="tracking_link" href="#" target="_blank" class="link-box"></a>
                    <button class="button whatsapp" id="wa_send" onclick="sendWhatsApp()">Send via WhatsApp</button>
                </div>
            </div>

            <div class="col-right">
                <div class="map-box">
                    <div id="map"></div>
                    <div id="stats" class="bottom-stats"></div>
                </div>
            </div>
        </div>
    </div>

<script>
/* ===========================
   DRIVER DASHBOARD SCRIPT
   =========================== */

const socket = io("https://connection-backend-bdob.onrender.com", {
    transports: ["websocket", "polling"],
    upgrade: true,
    reconnection: true,
});

let map = null;
let driverMarker = null;
let receiverMarker = null;
let routePolyline = null;
let gpsStarted = false;

let delivery_id = null;
let hasShownMap = false;
let awaitingWhatsApp = false;

let lastRouteCall = 0;
const ROUTE_THROTTLE_MS = 1200;

/* -------------- Utilities -------------- */
function cleanPhone(raw) {
    if (!raw) return "";
    let cleaned = raw.replace(/\D+/g, "");
    if (cleaned.startsWith("0")) cleaned = "250" + cleaned.slice(1);
    return cleaned;
}
function formatKm(km) { return (km || 0).toFixed(2) + " km"; }
function formatMin(min) { return (min == null) ? "- min" : Math.round(min) + " min"; }

/* -------------- WhatsApp Helpers -------------- */
function normalizeRwandaNumber(num) {
    if (!num) return null;
    num = num.replace(/\D/g, "");
    if (num.startsWith("07")) return "250" + num.slice(1);
    if (num.startsWith("2507")) return num;
    if (num.length === 9 && num.startsWith("7")) return "250" + num;
    return num;
}
function openWhatsApp(phoneNumber, message) {
    const normalized = normalizeRwandaNumber(phoneNumber);
    if (!normalized) { alert("WhatsApp number missing"); return; }
    const encoded = encodeURIComponent(message || "");
    const url = `https://wa.me/${normalized}?text=${encoded}`;
    window.location.href = url;
}

/* -------------- Create session -------------- */
async function createSession() {
    const phone = document.getElementById("receiver_phone").value.trim();
    if (!phone) return alert("Please enter receiver phone");

    document.getElementById("create_btn").disabled = true;

    try {
        const res = await fetch("/driver/create-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ receiver_phone: phone })
        });
        const data = await res.json();
        if (!res.ok) {
            alert(data.error || "Failed to create session");
            document.getElementById("create_btn").disabled = false;
            return;
        }

        delivery_id = data.delivery_id;
        const linkElem = document.getElementById("tracking_link");
        linkElem.href = data.tracking_link;
        linkElem.textContent = data.tracking_link;
        document.getElementById("tracking_box").style.display = "block";

        if (socket && socket.connected) {
            socket.emit("join_delivery", { delivery_id, role: "driver" });
        }

    } catch (err) {
        console.error(err);
        alert("Network error");
    } finally {
        document.getElementById("create_btn").disabled = false;
    }
}

/* -------------- WhatsApp flow + fade-in -------------- */
function sendWhatsApp() {
    const raw = document.getElementById("receiver_phone").value;
    const phone = cleanPhone(raw);
    const link = document.getElementById("tracking_link").href;
    const message = `Track me live:\n${link}`;

    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, "_blank");

    awaitingWhatsApp = true;

    setTimeout(() => {
        awaitingWhatsApp = false;
        showMapAfterSend();
    }, 2200);
}

/* -------------- Corrected showMapAfterSend -------------- */
function showMapAfterSend() {
    if (hasShownMap) return;
    hasShownMap = true;

    const left = document.querySelector(".col-left");
    const mapDiv = document.getElementById("map");

    // Fade out left panel
    left.style.transition = "opacity .45s, transform .45s";
    left.style.opacity = 0;
    left.style.transform = "translateY(-8px)";

    setTimeout(() => {
        left.style.display = "none";

        // âœ… SHOW MAP WITHOUT display:none
        mapDiv.style.opacity = "1";
        mapDiv.style.pointerEvents = "auto";
        mapDiv.classList.add("fade-in");

        // Wait for layout to complete before initializing Leaflet
        requestAnimationFrame(() => {
            initMap();

            // ðŸ”¥ REQUIRED after visibility change
            setTimeout(() => {
                map.invalidateSize();
            }, 50);

            // Emit initial driver location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;

                        if (!driverMarker) {
                            driverMarker = L.marker([lat, lng], {
                                icon: L.icon({ iconUrl: "/static/driver.png", iconSize: [20, 20] })
                            }).addTo(map);
                        } else {
                            smoothMoveMarker(driverMarker, lat, lng);
                        }

                        if (delivery_id) {
                            socket.emit("driver_update", { delivery_id, lat, lng, speed: 0 });
                        }
                    },
                    err => console.warn("GPS failed:", err),
                    { enableHighAccuracy: true }
                );
            }

            // Auto-zoom will happen naturally via GPS/socket
            startGPS();
        });

    }, 480);
}


/* -------------- Map initialization -------------- */
function initMap() {
    if (map) return;
    map = L.map("map", { zoomControl: false }).setView([-1.94995, 30.0588], 14);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    if (window.innerWidth > 700) {
        L.control.zoom({ position: 'topright' }).addTo(map);
    }
}

/* -------------- Smooth marker movement -------------- */
function smoothMoveMarker(marker, newLat, newLng, duration = 800) {
    if (!marker) return;
    const startPos = marker.getLatLng();
    const endPos = L.latLng(newLat, newLng);
    const startTime = performance.now();

    function animate(t) {
        const progress = Math.min((t - startTime) / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3);
        const currentLat = startPos.lat + (endPos.lat - startPos.lat) * eased;
        const currentLng = startPos.lng + (endPos.lng - startPos.lng) * eased;
        marker.setLatLng([currentLat, currentLng]);
        if (progress < 1) requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
}

/* -------------- Draw polyline & auto-fit -------------- */
function drawPolyline(poly) {
    if (!map) return;
    if (routePolyline) {
        map.removeLayer(routePolyline);
        routePolyline = null;
    }
    if (!poly || poly.length === 0) return;

    routePolyline = L.polyline(poly, { color: "#0077ff", weight: 5, opacity: 0.95 }).addTo(map);
    fitMapToActors();
}

/* -------------- Fit map to markers -------------- */
function fitMapToActors() {
    if (!map) return;
    let bounds = L.latLngBounds([]);
    if (driverMarker) bounds.extend(driverMarker.getLatLng());
    if (receiverMarker) bounds.extend(receiverMarker.getLatLng());
    if (routePolyline) bounds.extend(routePolyline.getBounds());
    if (bounds.isValid()) map.fitBounds(bounds, { padding: [80, 80], maxZoom: 17, animate: true });
}

/* -------------- Route request -------------- */
async function requestRoute(start, end) {
    if (!start || !end) return;
    const now = Date.now();
    if (now - lastRouteCall < ROUTE_THROTTLE_MS) return;
    lastRouteCall = now;

    try {
        const res = await fetch("/api/route", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ start, end })
        });
        const j = await res.json();

        if (!res.ok || !j) { console.warn("Route API error", j); return; }

        let poly = (j.polyline && Array.isArray(j.polyline) && j.polyline.length > 1)
                    ? j.polyline
                    : [[start.lat, start.lng], [end.lat, end.lng]];

        drawPolyline(poly);

        const stats = document.getElementById("stats");
        if (stats) {
            const distanceKm = j.distance_km ?? 0;
            const etaMin = j.eta_min ?? 0;
            stats.style.display = "block";
            stats.innerText = `${formatKm(distanceKm)} Â· ${formatMin(etaMin)}`;
        }

    } catch (err) { console.error("requestRoute error:", err); }
}

/* -------------- GPS watch -------------- */
function startGPS() {
    if (!navigator.geolocation) { alert("Your device does not support GPS."); return; }

    navigator.geolocation.watchPosition(
        pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const speed = pos.coords.speed || 0;

            if (!driverMarker) {
                driverMarker = L.marker([lat, lng], {
                    icon: L.icon({ iconUrl: "/static/driver.png", iconSize: [20, 20] })
                }).addTo(map);
                map.setView([lat, lng], 16);
            } else {
                smoothMoveMarker(driverMarker, lat, lng);
            }

            if (delivery_id) socket.emit("driver_update", { delivery_id, lat, lng, speed });

            if (receiverMarker) {
                const rpos = receiverMarker.getLatLng();
                requestRoute({ lat, lng }, { lat: rpos.lat, lng: rpos.lng });
            }

            fitMapToActors();
        },
        err => console.warn("GPS failed:", err),
        { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
    );
}

/* -------------- Socket events -------------- */
socket.on("connect", () => {
    console.log("socket connected");
    if (delivery_id) socket.emit("join_delivery", { delivery_id, role: "driver" });
    if (hasShownMap && !gpsStarted) { startGPS(); gpsStarted = true; }
});

socket.on("driver_update", (data) => {
    if (!data || data.lat === undefined || data.lng === undefined) return;
    const lat = parseFloat(data.lat);
    const lng = parseFloat(data.lng);

    if (!driverMarker && map) driverMarker = L.marker([lat, lng], { title: "Driver" }).addTo(map);
    else smoothMoveMarker(driverMarker, lat, lng);

    if (receiverMarker) {
        const rpos = receiverMarker.getLatLng();
        requestRoute({ lat, lng }, { lat: rpos.lat, lng: rpos.lng });
    }

    fitMapToActors();
});

socket.on("receiver_update", (data) => {
    if (!data || data.lat === undefined || data.lng === undefined) return;
    const lat = parseFloat(data.lat);
    const lng = parseFloat(data.lng);

    if (!receiverMarker && map) receiverMarker = L.marker([lat, lng], { title: "You" }).addTo(map);
    else smoothMoveMarker(receiverMarker, lat, lng);

    if (driverMarker) {
        const dpos = driverMarker.getLatLng();
        requestRoute({ lat: dpos.lat, lng: dpos.lng }, { lat, lng });
    } else if (map) {
        map.setView([lat, lng], 14);
    }

    fitMapToActors();
});

/* Optional debug helper */
function simulateReceiver(lat, lng) {
    if (!delivery_id) return;
    socket.emit("receiver_update", { delivery_id, lat, lng });
}

window.addEventListener("resize", () => {
    if (map) map.invalidateSize();
});
</script>

</body>
</html>
