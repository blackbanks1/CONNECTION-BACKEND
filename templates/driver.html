<!DOCTYPE html>
<html>
<head>
    <title>Connection — Driver Dashboard</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f4f6f9;
            font-family: Arial, sans-serif;
        }

        /* NAVBAR */
        .navbar {
            display: flex;
            align-items: center;
            background: #0066ff;
            padding: 14px 20px;
            color: white;
            font-size: 22px;
            font-weight: bold;
        }

        .navbar img {
            height: 38px;
            margin-right: 10px;
        }

        /* CARD */
        .card {
            width: 90%;
            max-width: 460px;
            margin: 30px auto;
            background: white;
            padding: 22px;
            border-radius: 14px;
            box-shadow: 0 8px 18px rgba(0,0,0,0.12);
            transition: all 0.4s;
        }

        .input {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            border-radius: 10px;
            border: 1px solid #bbb;
            font-size: 16px;
        }

        .button {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            font-size: 17px;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.2s;
        }

        .button:hover {
            opacity: 0.9;
        }

        .whatsapp {
            background: #25D366;
        }

        /* LINK BOX */
        .link-box {
            background: #eef4ff;
            padding: 12px;
            margin-top: 15px;
            border-radius: 10px;
            display: block;
            word-break: break-all;
            color: #0066ff;
            text-decoration: none;
            font-size: 15px;
            box-shadow: inset 0 0 3px rgba(0,0,0,0.08);
        }

        /* MAP */
        #map {
            width: 94%;
            height: 70vh;
            margin: 20px auto;
            border-radius: 16px;
            display: none;
            border: 2px solid #d6ddff;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        /* ANIMATIONS */
        .fade-out {
            animation: fadeOut 0.7s forwards;
        }

        @keyframes fadeOut {
            from {opacity: 1;}
            to {opacity: 0; height: 0; margin: 0; padding: 0; visibility: hidden;}
        }

        .fade-in {
            animation: fadeIn 0.8s forwards;
        }

        @keyframes fadeIn {
            from {opacity: 0; transform: translateY(20px);}
            to {opacity: 1; transform: translateY(0);}
        }

        .notice {
            text-align: center;
            font-size: 14px;
            margin-top: 10px;
            color: #444;
        }
    </style>
</head>

<body>

<div class="navbar">
    <img src="/static/logo.png">
    Connection — Driver
</div>

<div class="card" id="input_card">
    <h2 style="margin-top:0;">Start a Delivery Session</h2>

    <label>Receiver Phone Number</label>
    <input class="input" id="receiver_phone" placeholder="E.g. 0788 123 456">

    <button class="button" onclick="createSession()">Create Session</button>

    <p class="notice">Please allow location access when your browser asks.</p>

    <div id="tracking_box" style="display:none;">
        <a id="tracking_link" href="#" target="_blank" class="link-box"></a>
        <button class="button whatsapp" onclick="sendWhatsApp()">Send via WhatsApp</button>
    </div>
</div>

<div id="map"></div>

<script>
    let socket = io();
    let map, driverMarker, delivery_id;

    /* ----------------------------
       PHONE CLEANING (RWANDA DEFAULT)
       ---------------------------- */
    function cleanPhone(raw) {
        let cleaned = raw.replace(/\D+/g, "");

        if (cleaned.startsWith("0")) {
            cleaned = "250" + cleaned.slice(1);
        }

        return cleaned;
    }

    /* ----------------------------
       CREATE SESSION
       ---------------------------- */
    function createSession() {
        let phone = document.getElementById("receiver_phone").value;

        fetch("/driver/create-session", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ receiver_phone: phone })
        })
        .then(res => res.json())
        .then(data => {
            delivery_id = data.delivery_id;

            document.getElementById("tracking_box").style.display = "block";
            let linkElem = document.getElementById("tracking_link");
            linkElem.href = data.tracking_link;
            linkElem.textContent = data.tracking_link;
        });
    }


    /* ----------------------------
       WHATSAPP SHARE + RETURN TO MAP
       ---------------------------- */
    function sendWhatsApp() {
        let raw = document.getElementById("receiver_phone").value;
        let phone = cleanPhone(raw);
        let link = document.getElementById("tracking_link").href;

        let message = `Track me live:\n${link}`;

        // Open WhatsApp app/web
        window.open(
            `https://wa.me/${phone}?text=${encodeURIComponent(message)}`,
            "_blank"
        );

        // User returns → map appears
        setTimeout(() => {
            fadeIntoMap();
        }, 2000);
    }


    /* ----------------------------
       MAP + GPS
       ---------------------------- */
    function fadeIntoMap() {
        document.getElementById("input_card").classList.add("fade-out");

        setTimeout(() => {
            let m = document.getElementById("map");
            m.style.display = "block";
            m.classList.add("fade-in");

            initMap();
            startGPS();
        }, 700);
    }

    function initMap() {
        map = L.map("map").setView([-1.94995, 30.0588], 14);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
            .addTo(map);
    }

    function startGPS() {
        navigator.geolocation.watchPosition(pos => {
            let lat = pos.coords.latitude;
            let lng = pos.coords.longitude;

            if (!driverMarker) {
                driverMarker = L.marker([lat, lng]).addTo(map);
            } else {
                driverMarker.setLatLng([lat, lng]);
            }

            map.setView([lat, lng]);

            socket.emit("driver_update", {
                delivery_id: delivery_id,
                lat: lat,
                lng: lng
            });
        });
    }
</script>

</body>
</html>
