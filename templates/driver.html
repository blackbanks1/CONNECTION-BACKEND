<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Connection — Driver Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>

<body class="dark-theme"> <aside class="panel fade-in">
    <div class="card">
      <h3>Driver Console</h3>
      
      <div id="setup-section">
        <label style="color: var(--text-secondary-dark); font-size: 0.85rem;">Driver Phone Number</label>
        <input type="text" id="driver_phone" placeholder="e.g. 2348123456789">
        
        <button id="create_btn" class="pulse">Start Live Session</button>
      </div>

      <div id="error-banner" class="message error"></div>
      <div id="success-banner" class="message success"></div>

      <div id="controls" style="display:none; margin-top: 20px;">
        <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 20px 0;">
        
        <p style="font-size: 0.9rem; margin-bottom: 10px;">
          Share tracking link with customer:
        </p>
        <button id="wa_send" style="background: #25D366;">
          Share via WhatsApp
        </button>
        
        <button id="end_session_btn" style="background: var(--error); margin-top: 10px;">
          End Delivery
        </button>
      </div>
    </div>
  </aside>

  <div id="map"></div>


  <script>
  /* ===========================
     DRIVER DASHBOARD SCRIPT - FIXED VERSION
     =========================== */

  // GLOBAL VARIABLES
  let socket = null;
  let map = null;
  let driverMarker = null;
  let receiverMarker = null;
  let routePolyline = null;
  let gpsWatchId = null;
  let delivery_id = null;
  let hasShownMap = false;
  let lastRouteCall = 0;
  const ROUTE_THROTTLE_MS = 800;

  // CONFIGURATION
  const BACKEND_URL = (() => {
    const host = window.location.hostname;
    if (host === "localhost" || host === "127.0.0.1") return "http://localhost:8000";
    return window.location.origin;
  })();

  /* ===========================
     UI HELPER FUNCTIONS
     =========================== */
  let errorHideTimer = null;
  let successHideTimer = null;

  function showError(message) {
    const errorBox = document.getElementById("error-box");
    if (!errorBox) return;
    errorBox.textContent = message;
    errorBox.style.display = "block";
    if (errorHideTimer) clearTimeout(errorHideTimer);
    errorHideTimer = setTimeout(() => {
      errorBox.style.display = "none";
      errorHideTimer = null;
    }, 5000);
  }

  function showSuccess(message) {
    const successBox = document.getElementById("success-box");
    if (!successBox) return;
    successBox.textContent = message;
    successBox.style.display = "block";
    if (successHideTimer) clearTimeout(successHideTimer);
    successHideTimer = setTimeout(() => {
      successBox.style.display = "none";
      successHideTimer = null;
    }, 5000);
  }

  function updateConnectionStatus(connected) {
    const indicator = document.getElementById("connection-status");
    if (!indicator) return;
    indicator.className = "status-indicator " + (connected ? "connected" : "disconnected");
  }

  /* ===========================
     PHONE UTILITIES (RWANDA)
     =========================== */
  function normalizeRwandaNumber(raw) {
    if (!raw) return null;
    const digits = raw.replace(/\D/g, "");

    if (digits.startsWith("2507") && digits.length === 12) return digits;
    if (digits.startsWith("07") && digits.length === 10) return "250" + digits;
    if (digits.length === 9 && digits.startsWith("7")) return "250" + digits;
    return null;
  }

  function formatKm(km) {
    return (km || 0).toFixed(2) + " km";
  }

  function formatMin(min) {
    return min == null ? "- min" : Math.round(min) + " min";
  }

  /* ===========================
     MAP VISIBILITY
     =========================== */
  function ensureMapVisible() {
    const section = document.getElementById("map-section");
    if (!section) return;
    if (!hasShownMap) {
      section.classList.add("show");
      hasShownMap = true;
    }
    setTimeout(() => {
      if (map && typeof map.invalidateSize === "function") {
        map.invalidateSize();
      }
    }, 200);
  }

  /* ===========================
     SESSION MANAGEMENT
     =========================== */
  async function createSession() {
    const btn = document.getElementById("create_btn");
    const phoneInput = document.getElementById("receiver_phone");
    const trackingBox = document.getElementById("tracking_box");
    const linkElem = document.getElementById("tracking_link");

    if (!phoneInput) {
      showError("Phone input not found");
      return;
    }

    const normalized = normalizeRwandaNumber(phoneInput.value.trim());
    if (!normalized) {
      showError("Enter a valid Rwanda number (e.g., 0788 123 456)");
      return;
    }

    if (btn) btn.disabled = true;

    let data;
    try {
      const res = await fetch(BACKEND_URL + "/driver/create-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ receiver_phone: normalized }),
        credentials: "include",
      });

      try {
        data = await res.json();
      } catch (e) {
        showError("Invalid server response");
        if (btn) btn.disabled = false;
        return;
      }

      if (!res.ok) {
        showError(data?.error || "Failed to create session");
        if (btn) btn.disabled = false;
        return;
      }
    } catch (err) {
      console.error(err);
      showError("Network error: " + (err?.message || "Unknown"));
      if (btn) btn.disabled = false;
      return;
    }

    // Success flow
    delivery_id = data.delivery_id;

    if (data.tracking_link && linkElem && trackingBox) {
      linkElem.href = data.tracking_link;
      linkElem.textContent = data.tracking_link;
      trackingBox.style.display = "block";
      showSuccess("Session created! Share the tracking link.");
    } else {
      showError("Tracking link not generated");
      if (btn) btn.disabled = false;
      return;
    }

    // Join socket room
    if (socket) {
      if (socket.connected) {
        socket.emit("join_delivery", { delivery_id, role: "driver" });
      } else {
        const onceConnect = () => {
          socket.emit("join_delivery", { delivery_id, role: "driver" });
          socket.off("connect", onceConnect);
        };
        socket.once("connect", onceConnect);
      }
    }

    // Show map
    showMapSection();
    if (btn) btn.disabled = false;
  }

  /* ===========================
     MAP SECTION LOGIC
     =========================== */
  function showMapSection() {
    if (hasShownMap) return;
    hasShownMap = true;

    const inputCard = document.getElementById("input-card");
    const mapSection = document.getElementById("map-section");

    if (inputCard) inputCard.classList.add("hidden");
    if (mapSection) mapSection.classList.add("show");

    setTimeout(() => {
      initMap();
      startGPS();
      
      // Center on current position if available
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            if (map) {
              map.setView([lat, lng], 16);
            }
          },
          () => {
            // Default to Kigali if GPS not available
            if (map) {
              map.setView([-1.94995, 30.0588], 14);
            }
          },
          { enableHighAccuracy: true, timeout: 5000 }
        );
      }
    }, 300);
  }

  function refreshMapView() {
    if (map) {
      map.invalidateSize();
    }
  }

  /* ===========================
     RESET UI
     =========================== */
  function resetUI() {
    delivery_id = null;
    hasShownMap = false;
    
    const phoneInput = document.getElementById("receiver_phone");
    if (phoneInput) phoneInput.value = "";

    if (gpsWatchId) {
      navigator.geolocation.clearWatch(gpsWatchId);
      gpsWatchId = null;
    }

    if (map) {
      map.off();
      map.remove();
      map = null;
    }
    
    driverMarker = null;
    receiverMarker = null;
    routePolyline = null;

    const inputCard = document.getElementById("input-card");
    const mapSection = document.getElementById("map-section");
    const trackingBox = document.getElementById("tracking_box");
    const createBtn = document.getElementById("create_btn");

    if (mapSection) mapSection.classList.remove("show");
    if (inputCard) inputCard.classList.remove("hidden");
    if (trackingBox) trackingBox.style.display = "none";
    if (createBtn) createBtn.disabled = false;
    
    // Update stats
    const stats = document.getElementById("stats");
    if (stats) {
      stats.style.display = "none";
    }
  }

  /* ===========================
     WHATSAPP SHARING
     =========================== */
  function sendWhatsApp() {
    const raw = document.getElementById("receiver_phone")?.value;
    const normalized = normalizeRwandaNumber(raw);
    const linkElem = document.getElementById("tracking_link");
    
    if (!linkElem || !linkElem.href) {
      showError("Tracking link not available");
      return;
    }
    
    if (!normalized) {
      showError("Invalid phone number for WhatsApp");
      return;
    }

    const message = "Track me live:\n" + linkElem.href;
    window.open("https://wa.me/" + normalized + "?text=" + encodeURIComponent(message), "_blank");
  }

  /* ===========================
     END SESSION
     =========================== */
  async function endSession() {
    if (!delivery_id) {
      showError("No active session to end");
      return;
    }

    try {
      const res = await fetch(BACKEND_URL + "/driver/end-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ delivery_id }),
        credentials: "include",
      });

      const data = await res.json();
      if (!res.ok) {
        showError(data.error || "Failed to end session");
        return;
      }

      showSuccess("Session ended successfully");
    } catch (err) {
      console.error(err);
      showError("Network error: " + err.message);
    }

    resetUI();
  }

  /* ===========================
     MAP & MARKERS
     =========================== */
 function updateMarker(lat, lng) {
      if (!marker) {
        marker = L.marker([lat, lng]).addTo(map)
          .bindTooltip("You (Driver)", { 
             permanent: true, 
             direction: 'top',
             className: 'receiver-label' // This triggers the SCSS style!
          });
      } else {
        marker.setLatLng([lat, lng]);
      }
      map.setView([lat, lng]);
    }
  function initMap() {
    if (map) return;

    try {
      const mapDiv = document.getElementById("map");
      if (!mapDiv) return;
      
      map = L.map(mapDiv, {
        zoomControl: false,
        attributionControl: true,
      }).setView([-1.94995, 30.0588], 14);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
      }).addTo(map);

      if (window.innerWidth > 700) {
        L.control.zoom({ position: "topright" }).addTo(map);
      }
      map.attributionControl.setPosition("bottomright");
    } catch (err) {
      console.error("Map init error:", err);
      showError("Failed to initialize map");
    }
  }

  /* ===========================
     SMOOTH MARKER MOVEMENT
     =========================== */
  function smoothMoveMarker(marker, newLat, newLng, duration = 800) {
    if (!marker) return;
    const startPos = marker.getLatLng();
    const endPos = L.latLng(newLat, newLng);
    const startTime = performance.now();

    function animate(t) {
      const progress = Math.min((t - startTime) / duration, 1);
      const eased = 1 - Math.pow(1 - progress, 3);
      const currentLat = startPos.lat + (endPos.lat - startPos.lat) * eased;
      const currentLng = startPos.lng + (endPos.lng - startPos.lng) * eased;
      marker.setLatLng([currentLat, currentLng]);
      if (progress < 1) requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
  }

  /* ===========================
     POLYLINE DRAWING
     =========================== */
  function drawPolyline(poly) {
    if (!map) return;
    if (routePolyline) {
      map.removeLayer(routePolyline);
      routePolyline = null;
    }
    if (!poly || poly.length === 0) return;

    routePolyline = L.polyline(poly, {
      color: "#0077ff",
      weight: 5,
      opacity: 0.95,
    }).addTo(map);

    fitMapToActors();
  }

  function fitMapToActors() {
    if (!map) return;
    let bounds = L.latLngBounds([]);
    if (driverMarker) bounds.extend(driverMarker.getLatLng());
    if (receiverMarker) bounds.extend(receiverMarker.getLatLng());
    if (routePolyline) bounds.extend(routePolyline.getBounds());
    if (bounds.isValid()) {
      map.fitBounds(bounds, { padding: [80, 80], maxZoom: 17, animate: true });
    }
  }

  /* ===========================
     ROUTES & GPS
     =========================== */
  async function requestRoute(start, end) {
    if (!start || !end) return;
    const now = Date.now();
    if (now - lastRouteCall < ROUTE_THROTTLE_MS) return;
    lastRouteCall = now;

    try {
      const res = await fetch(BACKEND_URL + "/api/route", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ start, end }),
      });

      let j;
      try {
        j = await res.json();
      } catch {
        console.error("Invalid route response");
        return;
      }

      if (!res.ok || !j) return;

      let poly =
        j.polyline && Array.isArray(j.polyline) && j.polyline.length > 1
          ? j.polyline
          : [[start.lat, start.lng], [end.lat, end.lng]];

      drawPolyline(poly);

      const stats = document.getElementById("stats");
      if (stats) {
        const distanceKm = j.distance_km;
        const etaMin = j.eta_min;
        stats.style.display = "block";
        stats.innerText =
          (distanceKm ? formatKm(distanceKm) : "- km") + " · " +
          (etaMin ? formatMin(etaMin) : "- min");
      }
    } catch (err) {
      console.error("Route error:", err);
    }
  }

  function startGPS() {
    if (!navigator.geolocation) {
      showError("GPS not supported on this device");
      return;
    }

    gpsWatchId = navigator.geolocation.watchPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const speed = pos.coords.speed || 0;

        if (!map) initMap();

        if (!driverMarker && map) {
          driverMarker = createMarker(lat, lng, "driver", "Driver");
          driverMarker.addTo(map);
          if (map) {
            map.setView([lat, lng], 16);
          }
        } else if (driverMarker) {
          smoothMoveMarker(driverMarker, lat, lng);
        }

        if (delivery_id && socket) {
          socket.emit("driver_update", { delivery_id, lat, lng, speed });
        }

        if (receiverMarker) {
          const rpos = receiverMarker.getLatLng();
          requestRoute({ lat, lng }, { lat: rpos.lat, lng: rpos.lng });
        }

        fitMapToActors();
      },
      err => {
        console.warn("GPS error:", err);
        if (err.code === 1) {
          showError("GPS permission denied");
        }
      },
      { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
    );
  }

  /* ===========================
     SOCKET INITIALIZATION & EVENTS
     =========================== */
  function initializeSocket() {
    socket = io(BACKEND_URL, {
      transports: ["websocket", "polling"],
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      reconnectionAttempts: 5,
    });

    // Single connect handler
    socket.on("connect", () => {
      console.log("Socket connected");
      updateConnectionStatus(true);
      if (delivery_id) {
        socket.emit("join_delivery", { delivery_id, role: "driver" });
      }
    });

    socket.on("disconnect", () => {
      console.log("Socket disconnected");
      updateConnectionStatus(false);
    });

    socket.on("connect_error", (error) => {
      console.error("Socket connection error:", error);
      updateConnectionStatus(false);
    });

    socket.on("driver_update", (data) => {
      if (!data || data.lat === undefined) return;
      const lat = parseFloat(data.lat);
      const lng = parseFloat(data.lng);

      if (!map) initMap();

      if (!driverMarker && map) {
        driverMarker = createMarker(lat, lng, "driver", "Driver");
        driverMarker.addTo(map);
      } else if (driverMarker) {
        smoothMoveMarker(driverMarker, lat, lng);
      }

      if (receiverMarker) {
        const rpos = receiverMarker.getLatLng();
        requestRoute({ lat, lng }, { lat: rpos.lat, lng: rpos.lng });
      }

      fitMapToActors();
    });

    socket.on("receiver_update", (data) => {
      if (!data || data.lat === undefined) return;
      const lat = parseFloat(data.lat);
      const lng = parseFloat(data.lng);

      if (!map) initMap();

      if (!receiverMarker && map) {
        receiverMarker = createMarker(lat, lng, "receiver", "Receiver");
        receiverMarker.addTo(map);
      } else if (receiverMarker) {
        smoothMoveMarker(receiverMarker, lat, lng);
      }

      if (driverMarker) {
        const dpos = driverMarker.getLatLng();
        requestRoute({ lat: dpos.lat, lng: dpos.lng }, { lat, lng });
      } else if (map) {
        map.setView([lat, lng], 14);
      }

      fitMapToActors();
    });

    socket.on("join_delivery", (data) => {
      console.log("Joined delivery:", data);
    });

    socket.on("error_event", (error) => {
      console.error("Server error:", error);
      showError("Server error: " + (error.error || "Unknown"));
    });
  }

  /* ===========================
     INITIALIZATION
     =========================== */
  function initializeApp() {
    // Initialize Socket.IO
    initializeSocket();
    
    // Bind button events
    const createBtn = document.getElementById("create_btn");
    const waBtn = document.getElementById("wa_send");
    const endBtn = document.getElementById("end_session_btn");
    
    if (createBtn) {
      createBtn.addEventListener("click", createSession);
    }
    
    if (waBtn) {
      waBtn.addEventListener("click", sendWhatsApp);
    }
    
    if (endBtn) {
      endBtn.addEventListener("click", endSession);
    }
    
    // Handle window events
    window.addEventListener("resize", refreshMapView);
    window.addEventListener("orientationchange", refreshMapView);
    
    // Handle page visibility for WhatsApp return
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible" && hasShownMap) {
        refreshMapView();
      }
    });
    
    // Cleanup on page unload
    window.addEventListener("beforeunload", () => {
      if (gpsWatchId) {
        navigator.geolocation.clearWatch(gpsWatchId);
      }
      if (socket) {
        socket.disconnect();
      }
    });
    
    console.log("Driver dashboard initialized");
  }

  // Start the application when DOM is ready
  document.addEventListener("DOMContentLoaded", initializeApp);

  </script>
</body>
</html>