<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Connection — Driver Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        :root{
            --accent: #0066ff;
            --muted: #667085;
            --success: #00b894;
            --whatsapp: #25D366;
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: #f4f6f9;
            -webkit-font-smoothing: antialiased;
            color: #222;
        }

        .navbar {
            display:flex; align-items:center; gap:.75rem;
            background: var(--accent); color: #fff; padding:12px 18px;
            font-weight:700;
        }
        .navbar img{ height:34px; }

        .container {
            max-width:1100px; margin:16px auto; padding:0 14px;
        }

        .card {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 12px 36px rgba(12,36,80,0.06);
            padding: 16px;
        }

        .row { display:flex; gap:18px; align-items:flex-start; }
        .col-left { width:360px; max-width:36%; }
        .col-right { flex:1; }

        h3 { margin:0 0 8px 0; font-size:18px; }
        label { display:block; margin-bottom:6px; color:var(--muted); font-size:13px; }
        .input {
            width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6e9ef; font-size:15px;
            box-sizing:border-box;
        }

        .button {
            width:100%; padding:12px; border-radius:10px; border:none; font-weight:700; cursor:pointer;
            background:var(--accent); color:#fff; margin-top:12px; font-size:15px;
        }
        .button.whatsapp { background: var(--whatsapp); margin-top:8px; }

        .link-box {
            display:block; margin-top:12px; padding:10px 12px; border-radius:8px; background:#eef6ff;
            color:var(--accent); word-break:break-all; text-decoration:none;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.03);
        }

        /* MAP BOX - professional shadowed container (not full-screen) */
        .map-box {
            margin-top:0;
            background: #ffffff;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 16px 48px rgba(12,36,80,0.06);
            position: relative;
            min-height: 420px;
        }
        #map { width:100%; height:72vh; border-radius:8px; display:none; }

        /* Fade-in class */
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(10px);} to { opacity:1; transform:none;} }

        /* Bottom stats overlay centered */
        .bottom-stats {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 18px;
            min-width: 220px;
            background: rgba(255,255,255,0.98);
            border-radius: 12px;
            padding: 10px 16px;
            box-shadow: 0 10px 30px rgba(12,36,80,0.12);
            font-weight:700;
            display:none;
            z-index: 9999;
            text-align:center;
        }

        .notice { color:var(--muted); font-size:13px; margin-top:8px; }

        @media (max-width: 900px) {
            .row { flex-direction:column; }
            .col-left { width:100%; max-width:100%; }
            #map { height:60vh; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <img src="/static/logo.png" alt="logo">
        Connection — Driver
    </div>

    <div class="container">
        <div class="card row">
            <div class="col-left">
                <h3>Start a Delivery Session</h3>

                <label for="receiver_phone">Receiver Phone Number</label>
                <input id="receiver_phone" class="input" placeholder="E.g. 0788 123 456" />

                <button class="button" id="create_btn" onclick="createSession()">Create Session</button>

                <p class="notice">Please allow location access when your browser asks.</p>

                <div id="tracking_box" style="display:none;">
                    <a id="tracking_link" href="#" target="_blank" class="link-box"></a>
                    <button class="button whatsapp" id="wa_send" onclick="sendWhatsApp()">Send via WhatsApp</button>
                </div>
            </div>

            <div class="col-right">
                <div class="map-box">
                    <div id="map"></div>
                    <div id="stats" class="bottom-stats"></div>
                </div>
            </div>
        </div>
    </div>
<script>
/* ===========================
   RECEIVER DASHBOARD SCRIPT - CORRECTED
   =========================== */

/* --- State --- */
let delivery_id = "{{ delivery_id }}";  // Must match driver
console.log("[Receiver] delivery_id =", delivery_id);

let map = null;
let driverMarker = null;
let receiverMarker = null;
let routePolyline = null;

let lastRouteCall = 0;
const ROUTE_THROTTLE_MS = 1300;

let socket;
let driverUpdateBuffer = [];  // buffer updates before map ready

/* ===========================
   SOCKET INIT
=========================== */
function initSocket() {
    socket = io(window.location.origin, {
        transports: ["websocket", "polling"]
    });

    socket.on("connect", () => {
        console.log("[Receiver] Socket connected:", socket.id);
        joinRoom();
        flushDriverBuffer();
    });

    socket.on("connect_error", e => console.error("[Receiver] Socket error:", e));
    socket.on("disconnect", () => console.log("[Receiver] Socket disconnected"));

    // Driver updates
    socket.on("driver_update", (data) => {
        if (!data || data.lat === undefined || data.lng === undefined) return;
        if (!map) {
            driverUpdateBuffer.push(data);
            return; // wait until map initialized
        }
        updateDriverMarker(data.lat, data.lng);
    });

    // Receiver updates (other devices tracking same delivery)
    socket.on("receiver_update", (data) => {
        if (!data || data.lat === undefined || data.lng === undefined) return;
        if (!map) return; // ignore until map ready
        updateReceiverMarker(data.lat, data.lng);
    });
}

initSocket();

/* ===========================
   JOIN ROOM
=========================== */
function joinRoom() {
    if (!delivery_id) return;

    console.log("[Receiver] Joining room:", delivery_id);
    socket.emit("join_delivery", { delivery_id, role: "receiver" });

    socket.on("joined_room", (data) => console.log("[Receiver] Successfully joined:", data));
}

/* ===========================
   MAP INIT
=========================== */
function requestLocation() {
    if (!navigator.geolocation) {
        alert("Your device does not support GPS.");
        return;
    }

    navigator.geolocation.getCurrentPosition(
        pos => {
            document.getElementById("permBox").style.display = "none";
            const card = document.getElementById("mapCard");
            card.style.display = "block";
            card.classList.add("fade-in");

            initMap(pos.coords.latitude, pos.coords.longitude);
            startReceiverTracking();
        },
        () => alert("Location is required for live updates."),
        { enableHighAccuracy: true }
    );
}

function initMap(lat, lng) {
    if (map) return;

    map = L.map("map").setView([lat, lng], 15);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
    }).addTo(map);

    // Create receiver marker immediately
    receiverMarker = L.marker([lat, lng], { title: "You" }).addTo(map);

    // Fit to driver if exists
    fitMapToMarkers();

    console.log("[Receiver] Map initialized");

    // Apply any buffered driver updates
    flushDriverBuffer();
}

/* ===========================
   BUFFER FLUSH
=========================== */
function flushDriverBuffer() {
    if (!map) return;
    while (driverUpdateBuffer.length) {
        const data = driverUpdateBuffer.shift();
        updateDriverMarker(data.lat, data.lng);
    }
}

/* ===========================
   UPDATE MARKERS
=========================== */
function updateDriverMarker(lat, lng) {
    if (!driverMarker) {
        driverMarker = L.marker([lat, lng], { title: "Driver" }).addTo(map);
    } else {
        smoothMoveMarker(driverMarker, { lat, lng }, 800);
    }

    if (receiverMarker) {
        const rPos = receiverMarker.getLatLng();
        requestRoute({ lat, lng }, { lat: rPos.lat, lng: rPos.lng });
        fitMapToMarkers();
    }
}

function updateReceiverMarker(lat, lng) {
    if (!receiverMarker) {
        receiverMarker = L.marker([lat, lng], { title: "You" }).addTo(map);
    } else {
        smoothMoveMarker(receiverMarker, { lat, lng }, 800);
    }

    if (driverMarker) {
        const dPos = driverMarker.getLatLng();
        requestRoute({ lat: dPos.lat, lng: dPos.lng }, { lat, lng });
        fitMapToMarkers();
    } else if (map) {
        map.setView([lat, lng], 14);
    }
}

/* ===========================
   SMOOTH MARKER ANIMATION
=========================== */
function smoothMoveMarker(marker, newLatLng, duration = 500) {
    if (!marker) return;
    const start = marker.getLatLng();
    const end = L.latLng(newLatLng.lat, newLatLng.lng);
    const startTime = performance.now();

    function animate(time) {
        const progress = Math.min((time - startTime) / duration, 1);
        const lat = start.lat + (end.lat - start.lat) * progress;
        const lng = start.lng + (end.lng - start.lng) * progress;
        marker.setLatLng([lat, lng]);
        if (progress < 1) requestAnimationFrame(animate);
    }

    requestAnimationFrame(animate);
}

/* ===========================
   FIT MAP TO MARKERS
=========================== */
function fitMapToMarkers() {
    if (!map) return;
    const bounds = L.latLngBounds([]);
    if (driverMarker) bounds.extend(driverMarker.getLatLng());
    if (receiverMarker) bounds.extend(receiverMarker.getLatLng());
    if (routePolyline) bounds.extend(routePolyline.getBounds());
    if (bounds.isValid()) map.flyToBounds(bounds, { padding: [80, 80], maxZoom: 17 });
}

/* ===========================
   ROUTE REQUEST
=========================== */
async function requestRoute(start, end) {
    if (!start || !end) return;
    const now = Date.now();
    if (now - lastRouteCall < ROUTE_THROTTLE_MS) return;
    lastRouteCall = now;

    try {
        const res = await fetch("/api/route", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ start, end })
        });
        const j = await res.json();
        if (!res.ok) return;

        if (routePolyline) map.removeLayer(routePolyline);
        routePolyline = L.polyline([[start.lat, start.lng], [end.lat, end.lng]], { color: "#0077ff", weight: 5 }).addTo(map);
    } catch (err) {
        console.error("requestRoute error", err);
    }
}

/* ===========================
   RECEIVER GPS TRACKING
=========================== */
function startReceiverTracking() {
    navigator.geolocation.watchPosition(
        pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            if (receiverMarker) moveMarkerSmooth(receiverMarker, { lat, lng }, 800);

            if (socket && socket.connected) {
                socket.emit("receiver_update", { delivery_id, lat, lng });
            }

            if (driverMarker) {
                const dPos = driverMarker.getLatLng();
                requestRoute({ lat: dPos.lat, lng: dPos.lng }, { lat, lng });
                fitMapToMarkers();
            }
        },
        err => console.warn("GPS error:", err),
        { enableHighAccuracy: true }
    );
}

/* ===========================
   DEBUG HELPER
=========================== */
function simulateDriver(lat, lng) {
    if (!delivery_id) return;
    socket.emit("driver_update", { delivery_id, lat, lng });
}

</script>


</body>
</html>
